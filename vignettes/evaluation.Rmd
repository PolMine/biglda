---
title: "Topic Model Evaluation"
author: "Andreas BlÃ¤tte (andreas.blaette@uni-due.de)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: topicmodelling.bibtex
vignette: >
  %\VignetteIndexEntry{Topic Model Evaluation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

## Load libraries

```{r, eval = TRUE}
library(biglda)
library(polmineR)
library(parallel)
library(purrr)
library(stringi)
library(ggplot2)

use("RcppCWB", corpus = "REUTERS")
```


## Settings

```{r, eval = TRUE}
if (!mallet_is_installed()) mallet_install()
cores_to_use <- detectCores() - 1L
```


## Prepare data

```{r make_instance_list, message = FALSE, eval = TRUE}
discard <- c(tm::stopwords("en"), capitalize(tm::stopwords("en")))

instance_list <- corpus("REUTERS") %>%
  split(s_attribute = "id") %>%
  get_token_stream(p_attribute = "word", subset = {!word %in% discard}) %>%
  lapply(tolower) %>%
  sapply(stri_c, collapse = "\n") %>%
  as.instance_list()
```


## Fit models

```{r fit_models, eval = TRUE, message = FALSE, fig.width = 10}
metrics <- lapply(
  seq(from = 6, to = 30, by = 2),
  function(k){
    message("... fitting model for k: ", k)
    BTM <- BigTopicModel(n_topics = k, alpha_sum = 5.1, beta = 0.1)
    BTM$addInstances(instance_list)
    BTM$setNumThreads(cores_to_use)
    BTM$setTopicDisplay(0L, 0L)
    BTM$logger$setLevel(rJava::J("java.util.logging.Level")$OFF)
    BTM$setNumIterations(1000L)
    BTM$estimate()
    lda <- as_LDA(BTM, verbose = FALSE)
    N <- BTM$getDocLengthCounts()
    data.frame(
      k = k,
      cao2009 = BigCao2009(X = B(lda)),
      arun2010 = BigArun2010(beta = B(lda), gamma = G(lda), doclengths = N),
      deveaud2014 = BigDeveaud2014(beta = B(lda))
    )
  }
)
df <- do.call(rbind, metrics)
```


## Plot metrics

```{r}
for (m in c("cao2009", "arun2010", "deveaud2014")){
  df[[m]] <- (df[[m]] - min(df[[m]])) / max(df[[m]] - min(df[[m]]))
}
plot(x = df$k, y = df$cao2009, ylab = "level", xlab = "k", type = "n")
lines(x = df$k, y = df$cao2009, col = "lightblue", lwd = 2)
lines(x = df$k, y = df$arun2010, col = "red", lwd = 2)
lines(x = df$k, y = df$deveaud2014, col = "green", lwd = 2)
```
